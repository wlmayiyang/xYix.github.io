---
title: luoguP7123 题解 - 【NEERC2016】 Indiana Jones and the Uniform Cave
---

> **题目大意.**
>
> 现在有一个未知但保证强连通的洞窟，共有不超过 $20$ 个房间。每个房间都均匀地在墙壁上开了 $m\le 20$ 扇单向传送门（$m$ 是已知的），进入门会导致你瞬移到另一端的房间中心，注意可能有自环。
>
> 每个房间里都有一个可以设为三种状态 $0,1,2$ 的小灯，初始为 $0$；和一个放在房间中心的路牌，初始时竖直指地。你在某房间内时可以任意调整它的灯并把路牌指向某个门。
>
> （注意，如果没有路牌，你将完全无法分辨门之间的区别。）
>
> 你的目标是在 $20000$ 次操作内遍历所有门。

显然我们可以用 $1$ 表示 ``vis``，但是 $2$ 有什么用？这是这道题的关键观察：$2$ 可以表示 ``in_stk``。

那么还有一个问题：路牌表示什么。我们知道边是单向的，即不总是存在一条回到父亲的边，所以它必定不是指向父亲。对于栈内，显然指向当前儿子；至于栈外，等下分析。

现在我们由节点 $u$ 进入一个门，考虑可能看到的景象：

- 遇到 $0$：继续搜。
- 遇到 $2$：在栈内，说明返祖了，设返到了 $v$。沿路牌走一定能返回 $u$，但是我们如何才能知道我们已经返回了 $u$？不妨临时把 $v$ 的灯设为 $0$，下次转圈转回 $v$ 我们就知道了，也就知道了整个圈的长度。
- 遇到 $1$：我们自然希望能返回原地。由于原图强连通，要是有无限路牌我们一定能成功返回栈。但路牌只有一个，所以我们必须小心维护。
- 于是自然会想：能返祖的自然直接返祖，没有疑问；不能直接返祖的走 ``low`` 即可，必定能返祖，而且不会发生返祖了却仍比 $u$ 低的尴尬情况。
- 一旦返回栈，再转一圈就又知道了。

----

现在只剩一个问题：结束访问某点时，我们如何"复位"？

（注意我们可以知道某个点的访问是否结束。根据上面的论述，每次可能走到新边时我们都知道自己身处何处。）

首先先把路牌摆好，摆成和其他 $1$ 的点一样，然后走 ``low`` 返祖即可，仍是走两圈就能复位。

