---
title: Unknown#1 题解 - 我不知道来源但这题的确有来源
---

据考证这题应该是一场牛客多校里的，但是没有权限看不了。

> **题目大意.**
>
> 令 $s_0=b,s_1=a$，对于 $i\ge 2,s_i=s_{i-1}s_{i-2}$。
>
> 给定 $n$。现在有 $q$ 个询问：$s_n$ 后缀排序后，排在第 $x$ 名的是哪一个后缀（用开头下标表示）。答案模非质数 $p$。
>
> $n\le 10^{18},m\le 5\times10^5,x_i\le 10^{18}$。$p$ 的大小不关键。

记 $F_n=|s_n|$，也就是斐波那契数列。

自然想到：既然每次拼接两个串，那么它们的后缀数组/后缀自动机是否也是简单拼接？

后缀数组并不如此，但是后缀自动机的确有一些规律。

>  $s_n$ 的后缀自动机是由一条主链和 $O(n)$ 条边组成，边均由 $F_{i}-2$ 指向 $F_{i+1}-1$，其上的字符随着 $i$ 的变动在 $a,b$ 间交替变换。

下面是 $n=5$ 的图。

<center><div style="width:100%;margin:0"><img src="https://xyix.github.io/images/unknown-1.png" style="width: 70%" alt=""></div></center>

有了后缀自动机，所欲求的问题自然就不难了。我们又发现可以把这个自动机[压缩](https://xyix.github.io/posts/?&postname=uoj-577)到 $3n$ 个节点，这就得到了一个 $O(n)$ 做法。

然后你会发现 $x$ 很小，所以只需要前面尽量跳 $1$，只考虑最后 $O(\log x)$ 个节点就够了，这就做完了。

写起来有、恶心。