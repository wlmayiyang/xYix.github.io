---
title: uoj#96 题解 - 【集训队互测2015】胡策的小树
---

> **题目大意. (part 1)**
>
> 有一棵 $n$ 个节点的树，根为 $1$，每个点附权值 $p_i=\begin{cases}0&(i=1)\\a_i/n&(i\ge 2)\end{cases}$，保证 $a$ 是一个 $1\sim n-1$ 的排列。一开始每个节点恰好有一只猴子。每个时刻，猴子都会行动一步，在节点 $i$ 的猴子会
>
> - 有 $p_i$ 的概率成功跳到 $i$ 的父亲；
> - 否则掉到 $i$ 的子树中，包括 $i$。
>
> 记第 $t$ 个时刻跳跃成功的猴子数为 $g_t$，求 $$\lim_{X\rightarrow +\infty}\dfrac{1}X{}\sum_{t=0}^{X} g_t$$ 的期望。

使用期望的线性：$\sum g$ 即每个猴子在跳到 $1$ 前期望成功跳几步，也即每个猴子在每个节点期望成功跳的次数，由于跳跃成功与否与其他一切因素独立，故也即每个猴子经过每个节点的期望次数 $\times p_i$。再除以 $X$ 就是每个猴子在任意时刻处于某节点的概率 $\times p_i$。

可以发现趋近于无穷的 $X$ 完全稀释了初始节点的影响，从而每只猴子的贡献相同。对于任意猴子，记它处于节点 $i$ 的概率为 $f_i$，则有转移
$$
f_i=\sum_{(i,j)}p_jf_j+\color{blue}\sum_{j 是i 的祖先}\dfrac{1-p_j}{\text{siz}_j}f_j\\
\sum f=1
$$
此处有一个技巧，称为**树上高斯消元**。具体来说是设 $f_{i}=k_{i}f_{fa}+b_i$，然后写开 $f_j=k_jf_i+b_j$，得到一个 $f_{fa}$ 和 $f_i$ 的线性关系：正是 $k_i,b_i$ 的表达式，于是其实最终得到的是 $k_i,b_i$ 的使用 $k_j,b_j$ 的表达，于是转移便具有单向性了。

然而困难在于 $\color{blue}\sum_{j 是i 的祖先}\tfrac{1-p_j}{\text{siz}_j}f_j$ 不好处理，于是我们把 $f_i$ 写为前缀和：
$$
F_i:=\sum_{j是i的祖先}\dfrac{1-p_j}{\text{siz}_j}f_j\\
f_i=\dfrac{\text{siz}_i}{1-p_i}(F_i-F_{fa})
$$
从而转移变为
$$
\dfrac{\text{siz}_i}{1-p_i}(F_i-F_{fa})=\sum_{(i,j)}\dfrac{\text{siz}_j}{1-p_j}(F_j-F_{i})+F_i
$$
这就好多了，直接把树上高消代入，就是有点恶心。

> **题目大意. (part 2)**
>
> 现只保证 $b$ 是一个 $1\sim n-1$ 的排列，然后对 $t=0\sim n-1$，令 $a_i=(b_i +t)\bmod n$，你要对任意 $t$ 求出结果。
>
> 保证树的形态随机，$b$ 亦随机。

注意到一定存在一个特殊节点，它满足 $a_i=0$，可以发现由于时间是无限的，所以所有点都可以看作从 $i$ 的子树出发而且永远跳不出 $i$ 的子树，又由于树的形态随机，所以我们每次直接暴力对 $i$ 的子树跑上面的算法即可。容易证明复杂度为 $O(n\log n)$。

