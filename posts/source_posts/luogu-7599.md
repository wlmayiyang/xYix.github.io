---
title: luoguP7599 题解 - 【APIO2021】雨林跳跃
---

> **题目大意.**
>
> 现在有 $n$ 棵树，第 $i$ 棵树的高度为 $h_i$。当你在 $i$ 号树上时，你可以
>
> - 跳到左边所有比 $i$ 高的树中的最右者
> - 或跳到右边所有比 $i$ 高的树中的最左者
>
> 现在，请你回答 $q$ 个询问，形如
>
> - 给出 $l_1\le r_1\ {\color{red}<}\ l_2\le r_2$，问是否存在一条以某个 $\in[l_1,r_1]$ 的树出发，到某个 $\in[l_2,r_2]$ 的树结束的路径。如果有，你还要回答所有这样的路径的最短者。
>
> $n\le 2\times10^5,q\le10^5$。

自然想到建出笛卡尔树。那么题目中所说的跳跃大概就是这个样子

<center><div style="width:70%;margin:0"><img src="https://xyix.github.io/images/luogu-7599.png" style="width: 70%" alt=""></div></center>

所以跳跃本质就是跳父亲，只不过跳的方向不同可以加速一点罢了。

----

首先有个经典结论：

> **结论 1.**
>
> 笛卡尔树上 $u$ 是 $v$ 的祖先，当且仅当 $u,v$（包括端点；因为如果 $v$ 比 $u$ 高那也不行）之间没有比 $u$ 高的元素。

当然其实根据题面也可以直接看出这个结论。

根据该结论，我们来考虑可达性。根据上述结论不难发现，如果只考虑可达，那么 $r_1$ 和 $[l_2,r_2]$ 中的最高者必定是一对可达性最好的起始点。于是只需要确认它们的祖先关系。

----

现在加进对步数的考虑。

对于 $[l_1,r_1]$ 的部分，考虑某个 $u$，如果 $u+1\sim r_1$ 中有至少一个比它高的，那么要么 $u$ 和该节点都到不了 $[l_2,r_2]$，要么不如从该节点跳；而对于 $[l_2,r_2]$ 的部分，考虑某个 $u$，如果 $l_2\sim u-1$ 中有至少一个比它高的，那么它就被该节点挡住了。即两边都有类似单调栈的模式。

<center><div style="width:100%;margin:0"><img src="https://xyix.github.io/images/luogu-7599-2.png" style="width: 70%" alt=""></div></center>

（上图中，绿边表示祖先关系。）

我们称这些在单调栈中凸显出来的元素是"亚优异"的；如果对于某个亚优异红元素，它高于整个 $[l_2,r_2]$，则我们再称它为"优异"的；如果对于某个亚优异蓝元素，存在一个优异红元素比他高，则我们再称它为"优异"的。

可见，最高的优异蓝元素是所有其他优异蓝元素的祖先，而且它一定可达：也就是说它在可达性和步数全都占优势，我们只需要考虑它就可以了。（定位它略有麻烦，需要难受的线段树上二分，此处不表。）

和它配对的自然就是首个高于它的优异红元素。（事实上就是首个高于它的元素。）接下来我们考虑它们之间的步数。

----

- 如果两者的距离很远，那么可以发现大跳一定比小跳优，直接不断"大跳"就可以了；（倍增。）

- 而如果距离已经很近，下一次大跳会越过代表红元素，那么就需要仔细斟酌了：
- - 我们自然可以一步一步小跳。（直接比深度。）
  - 然而如果越过代表红元素跳到的点是一个优异红元素，那么跳到这个点也确实可以。

---

嘴巴很简单，代码很苦痛！鸽了。

